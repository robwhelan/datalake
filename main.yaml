AWSTemplateFormatVersion: '2010-09-09'
Description: builds a HIPAA-compliant datalake
Parameters:
  pProjectName:
    Type: String
    Description: overall project name which will be used for tags
Resources:
  #IAM to produce the roles.
  rDeadLetterQueue:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        pProjectName: !Ref pProjectName
        pQueueName: !Sub '${pProjectName}-dead-letter-queue'
      TemplateURL: https://datalake-rww.s3.amazonaws.com/components/queue-dead-letter.yaml
      TimeoutInMinutes: 5
  rDropZone:
    Type: AWS::CloudFormation::Stack
    DependsOn: rDeadLetterQueue
    Properties:
      Parameters:
        pDeadLetterQueueArn: !GetAtt rDeadLetterQueue.Outputs.rQueueArn
        pKeyAdministrator: arn:aws:iam::773548596459:user/robwhelan
        pKeyUser: arn:aws:iam::773548596459:role/service-role/accountable-SMS-Role
        pProjectName: !Ref pProjectName
        pSqsQueueVisibilityTimeout: 120
        pTransitionClass: GLACIER
        pTransitionInDays: 7
        pZone: drop
      TemplateURL: https://datalake-rww.s3.amazonaws.com/components/zone.yaml
      TimeoutInMinutes: 15
  rRawZone:
    Type: AWS::CloudFormation::Stack
    DependsOn: rDeadLetterQueue
    Properties:
      Parameters:
        pDeadLetterQueueArn: !GetAtt rDeadLetterQueue.Outputs.rQueueArn
        pKeyAdministrator: arn:aws:iam::773548596459:user/robwhelan
        pKeyUser: arn:aws:iam::773548596459:role/service-role/accountable-SMS-Role
        pProjectName: !Ref pProjectName
        pSqsQueueVisibilityTimeout: 120
        pTransitionClass: GLACIER
        pTransitionInDays: 7
        pZone: raw
      TemplateURL: https://datalake-rww.s3.amazonaws.com/components/zone.yaml
      TimeoutInMinutes: 15
  rRefinedZone:
    Type: AWS::CloudFormation::Stack
    DependsOn: rDeadLetterQueue
    Properties:
      Parameters:
        pDeadLetterQueueArn: !GetAtt rDeadLetterQueue.Outputs.rQueueArn
        pKeyAdministrator: arn:aws:iam::773548596459:user/robwhelan
        pKeyUser: arn:aws:iam::773548596459:role/service-role/accountable-SMS-Role
        pProjectName: !Ref pProjectName
        pSqsQueueVisibilityTimeout: 120
        pTransitionClass: GLACIER
        pTransitionInDays: 7
        pZone: refined
      TemplateURL: https://datalake-rww.s3.amazonaws.com/components/zone.yaml
      TimeoutInMinutes: 15
  rCuratedZone:
    Type: AWS::CloudFormation::Stack
    DependsOn: rDeadLetterQueue
    Properties:
      Parameters:
        pDeadLetterQueueArn: !GetAtt rDeadLetterQueue.Outputs.rQueueArn
        pKeyAdministrator: arn:aws:iam::773548596459:user/robwhelan
        pKeyUser: arn:aws:iam::773548596459:role/service-role/accountable-SMS-Role
        pProjectName: !Ref pProjectName
        pSqsQueueVisibilityTimeout: 120
        pTransitionClass: GLACIER
        pTransitionInDays: 7
        pZone: curated
      TemplateURL: https://datalake-rww.s3.amazonaws.com/components/zone.yaml
      TimeoutInMinutes: 15

  #vpc
  #config rules
  #logging
  #other security, like macie
